name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '5.9'

      - name: Build Release
        run: |
          swift build -c release

      - name: Create App Bundle
        run: |
          chmod +x Scripts/build-app.sh
          ./Scripts/build-app.sh

      - name: Create DMG
        run: |
          hdiutil create -volname LuminaBar -srcfolder LuminaBar.app -ov -format UDZO LuminaBar.dmg

      - name: Create ZIP
        run: |
          ditto -c -k --sequesterRsrc --keepParent LuminaBar.app LuminaBar.app.zip

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Calculate SHA256
        id: sha
        run: |
          echo "DMG_SHA=$(shasum -a 256 LuminaBar.dmg | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "ZIP_SHA=$(shasum -a 256 LuminaBar.app.zip | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: LuminaBar ${{ steps.version.outputs.VERSION }}
          body: |
            ## LuminaBar ${{ steps.version.outputs.VERSION }}

            ### Installation

            **Homebrew:**
            ```bash
            brew tap ${{ github.repository_owner }}/tap
            brew install --cask luminabar
            ```

            **Manual:** Download `LuminaBar.dmg`, open it, and drag to Applications.

            ### Checksums (SHA256)
            - `LuminaBar.dmg`: `${{ steps.sha.outputs.DMG_SHA }}`
            - `LuminaBar.app.zip`: `${{ steps.sha.outputs.ZIP_SHA }}`
          files: |
            LuminaBar.dmg
            LuminaBar.app.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Update Homebrew Tap
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          git clone https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/YOURUSERNAME/homebrew-tap.git
          cd homebrew-tap
          VERSION=${GITHUB_REF#refs/tags/v}
          SHA=$(shasum -a 256 ../LuminaBar.dmg | awk '{print $1}')
          sed -i '' "s/version \".*\"/version \"$VERSION\"/" Casks/luminabar.rb
          sed -i '' "s/sha256 \".*\"/sha256 \"$SHA\"/" Casks/luminabar.rb
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Update LuminaBar to v$VERSION"
          git push          
